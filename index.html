<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Flappy Mo Lab — v1.46</title>

  <!-- Préchargement des visuels d'overlay -->
  <link rel="preload" as="image" href="assets/gameover.png">
  <link rel="preload" as="image" href="assets/retry.png">

  <style>
    :root { color-scheme: dark light; }
    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      touch-action: none;
      overscroll-behavior: none;
      background: #000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #stage { position: relative; width: 100vw; height: 100vh; background: #000; }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }

    /* HUD */
    .hud {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0px) + 8px);
      left: 8px; right: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
      user-select: none;
      pointer-events: none;
      font-weight: 600;
    }
    .hud .scores {
      display: flex; gap: 12px; font-size: 16px;
      padding: 6px 10px; background: rgba(0,0,0,.35); border-radius: 10px;
    }
    .hud .actions { pointer-events: auto; display: flex; gap: 8px; }
    .hud button {
      appearance: none; border: 0; border-radius: 10px;
      padding: 8px 12px; font-weight: 700; font-size: 14px;
      background: rgba(255,255,255,.15); color: #fff; cursor: pointer;
      backdrop-filter: blur(4px);
    }

    /* Overlay Start */
    #startOverlay {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,.4), rgba(0,0,0,.6));
      color: #fff; text-align: center; user-select: none;
    }
    #startOverlay .card {
      padding: 16px 18px; border-radius: 14px;
      background: rgba(0,0,0,.5); backdrop-filter: blur(4px);
      max-width: min(92vw, 520px);
    }

    /* Overlay Game Over fixé en haut */
    #gameOver {
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 0px);
      left: 0; right: 0;
      display: none;
      margin: 0 auto;
      z-index: 9999;
      transform: none;
      max-height: 100dvh;
      overflow: auto;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75));
      color: #fff;
    }
    #gameOver .panel {
      margin: 12px auto;
      padding: 16px;
      max-width: min(92vw, 520px);
      background: rgba(0,0,0,.55);
      border-radius: 14px;
      backdrop-filter: blur(4px);
    }

    /* Bloque les clics sur le canvas quand overlay actif */
    body.modal-open #gameCanvas { pointer-events: none; }

    /* Rotation Overlay */
    #rotate {
      display: none;
      position: absolute; inset: 0;
      background: rgba(0,0,0,.7);
      color: #fff;
      align-items: center; justify-content: center;
      text-align: center; padding: 20px;
    }

    /* Version tag */
    #ver {
      position: absolute; right: 8px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
      padding: 4px 8px; font-size: 12px; color: #fff; opacity: .75;
      background: rgba(0,0,0,.35); border-radius: 8px; user-select: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="stage">
    <canvas id="gameCanvas"></canvas>

    <div class="hud">
      <div class="scores">
        <div>Score: <span id="score">0</span></div>
        <div>Last: <span id="last">0</span></div>
        <div>Best: <span id="best">0</span></div>
      </div>
      <div class="actions">
        <button id="btnSound" type="button">Sound: Off</button>
        <button id="btnFull" type="button">Fullscreen</button>
      </div>
    </div>

    <div id="startOverlay">
      <div class="card">
        <h1>Flappy Mo Lab</h1>
        <p>Appuie pour démarrer. Espace ou ↑ au clavier.</p>
      </div>
    </div>

    <div id="gameOver">
      <div class="panel">
        <h2>Game Over</h2>
        <p>Score: <strong id="goScore">0</strong></p>
        <p>Best: <strong id="goBest">0</strong></p>
        <div class="actions">
          <button id="btnRetry" type="button">Retry</button>
          <button id="btnClose" type="button">Close</button>
        </div>
        <p style="opacity:.8;margin-top:10px;">Astuce: tape en dehors de cette fenêtre pour relancer.</p>
      </div>
    </div>

    <div id="rotate"><div class="msg"><h3>Rotate your device</h3></div></div>
    <div id="ver">v1.46</div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx    = canvas.getContext('2d');
    const elScore = document.getElementById('score');
    const elLast  = document.getElementById('last');
    const elBest  = document.getElementById('best');
    const elStart = document.getElementById('startOverlay');
    const elGameOver = document.getElementById('gameOver');
    const elBtnRetry = document.getElementById('btnRetry');
    const elBtnClose = document.getElementById('btnClose');
    const elBody = document.body;

    let isStarted = false, isGameOver = false, inputLocked = false;
    let W = 0, H = 0, DPR = Math.max(1, Math.min(window.devicePixelRatio||1,2));
    ctx.imageSmoothingEnabled = false;

    const GRAVITY=1500, FLAP=380, PIPE_GAP=180, PIPE_W=80, PIPE_SPACING=300, BIRD_X=0.28;
    let bird = {x:0,y:0,vy:0,r:18}, pipes=[], score=0,lastScore=0,bestScore=parseInt(localStorage.getItem('bestScore'),10)||0;

    function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
    function fit(){W=Math.floor(canvas.parentElement.clientWidth*DPR);
      H=Math.floor(canvas.parentElement.clientHeight*DPR);
      canvas.width=W; canvas.height=H; bird.x=Math.floor(W*BIRD_X);}
    window.addEventListener('resize',fit);

    function resetPipes(){pipes.length=0; let x=W+200; for(let i=0;i<Math.ceil(W/PIPE_SPACING)+2;i++){addPipe(x); x+=PIPE_SPACING;}}
    function addPipe(x){const m=60; const topH=Math.floor(m+Math.random()*(H-m*2-PIPE_GAP)); pipes.push({x,topH,passed:false});}
    function resetGame(){fit(); score=0; bird.y=Math.floor(H*0.38); bird.vy=0; resetPipes(); updateScoreUI();}
    function startGame(){isStarted=true; elStart.style.display='none'; resetGame();}

    function showGameOver(){isGameOver=true; inputLocked=true; elGameOver.style.display='block'; elBody.classList.add('modal-open');
      document.getElementById('goScore').textContent=score; document.getElementById('goBest').textContent=bestScore;
      setTimeout(()=>{inputLocked=false;},300);}
    function hideGameOver(){isGameOver=false; elGameOver.style.display='none'; elBody.classList.remove('modal-open');}

    elGameOver.addEventListener('pointerdown',e=>e.stopPropagation(),{passive:true});

    function flap(){if(!isStarted){startGame();return;} if(isGameOver)return; bird.vy=-FLAP;}
    function handleTap(){if(isGameOver){if(inputLocked)return; hideGameOver(); restartGame();return;} flap();}
    ['pointerdown','mousedown','touchstart'].forEach(evt=>{
      canvas.addEventListener(evt,e=>{e.preventDefault();handleTap();},{passive:false});});
    document.addEventListener('keydown',e=>{
      if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();handleTap();}});

    document.addEventListener('pointerdown',e=>{
      if(!isGameOver||inputLocked)return;
      if(!elGameOver.contains(e.target)){hideGameOver(); restartGame();}
    },{passive:true});

    elBtnRetry.addEventListener('click',()=>{if(inputLocked)return; hideGameOver(); restartGame();});
    elBtnClose.addEventListener('click',()=>{if(inputLocked)return; hideGameOver();});

    function updateScoreUI(){elScore.textContent=score; elLast.textContent=lastScore; elBest.textContent=bestScore;}

    function collide(){
      const bx1=bird.x-bird.r,bx2=bird.x+bird.r,by1=bird.y-bird.r,by2=bird.y+bird.r;
      if(by2>=H||by1<=0)return true;
      for(const p of pipes){if(bx2<p.x||bx1>p.x+PIPE_W)continue;
        if(by1<p.topH||by2>p.topH+PIPE_GAP)return true;} return false;}

    function update(dt){
      const speed=180;
      for(const p of pipes){p.x-=speed*dt;}
      if(pipes.length){if(pipes[0].x+PIPE_W<-50)pipes.shift();
        if(pipes[pipes.length-1].x<W+50)addPipe(pipes[pipes.length-1].x+PIPE_SPACING);}
      bird.vy+=GRAVITY*dt; bird.vy=clamp(bird.vy,-1000,900); bird.y+=bird.vy*dt;
      for(const p of pipes){if(!p.passed&&(p.x+PIPE_W)<bird.x){p.passed=true;score++;updateScoreUI();}}
      if(collide())onCrash();}
    function onCrash(){if(isGameOver)return; isGameOver=true; lastScore=score|0; bestScore=Math.max(bestScore,lastScore);
      localStorage.setItem('bestScore',String(bestScore)); updateScoreUI(); showGameOver();}
    function render(){ctx.fillStyle='#043';ctx.fillRect(0,0,W,H);
      for(const p of pipes){ctx.fillStyle='#2ecc71'; ctx.fillRect(p.x,0,PIPE_W,p.topH);
        const b=p.topH+PIPE_GAP; ctx.fillRect(p.x,b,PIPE_W,H-b);}
      ctx.beginPath();ctx.arc(bird.x,bird.y,bird.r,0,Math.PI*2);ctx.fillStyle='#f1c40f';ctx.fill();}

    let lastTS=performance.now(),acc=0,STEP=1000/60;
    function loop(ts){let dt=ts-lastTS;lastTS=ts;if(dt>100)dt=100; acc+=dt;
      while(acc>=STEP){if(isStarted&&!isGameOver)update(STEP/1000); acc-=STEP;}
      render(); requestAnimationFrame(loop);}
    function restartGame(){isGameOver=false; score=0; resetGame(); isStarted=true;}

    (function init(){fit(); requestAnimationFrame(loop);})();
  </script>
</body>
</html>
